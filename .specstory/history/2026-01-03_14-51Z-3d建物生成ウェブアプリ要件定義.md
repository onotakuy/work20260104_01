# 3d建物生成ウェブアプリ要件定義

## 概要

Google Earthの画像から範囲を選択して建物の3次元オブジェクトを生成し、二次元マップに配置するWebアプリケーションを作成します。

## 技術スタック

- **フレームワーク**: Next.js 14 (App Router)
- **データベース**: Supabase (PostgreSQL)
- **認証**: Better Auth
- **ストレージ**: Cloudflare R2
- **決済**: Polar
- **マップ**: Mapbox GL JS
- **3D表示**: Three.js

## 機能要件

### 1. マップ表示
- Mapbox Satelliteを使用した衛星画像の表示
- ズーム、パン操作
- 範囲選択機能（矩形選択）

### 2. 範囲選択
- ユーザーがマップ上で矩形範囲を選択
- 最大範囲: 1km x 1km
- 選択範囲の座標（北、南、東、西）を取得

### 3. ジョブ管理
- ジョブの作成（範囲選択から）
- ジョブ状態の管理（pending, running, succeeded, failed）
- ジョブ一覧の表示
- ジョブ詳細の表示

### 4. 3Dモデル生成（未実装）
- 選択範囲の画像を取得
- 3Dモデル生成処理（バックグラウンドジョブ）
- 生成された3DモデルをCloudflare R2に保存
- GLB形式で出力

### 5. 3Dモデル表示（未実装）
- マップ上に生成済み建物のマーカーを表示
- マーカーをクリックすると3Dプレビューを表示
- Three.jsを使用した3D表示

### 6. 認証（未実装）
- Better Authを使用したユーザー認証
- ログイン/ログアウト機能
- ユーザーごとのジョブ管理

### 7. 決済（未実装）
- Polarを使用した決済機能
- プラン管理（free, pro, enterprise）
- 使用量に応じた課金

## データベーススキーマ

### users テーブル
- id: UUID (Primary Key)
- email: TEXT (Unique)
- role: TEXT (user, admin)
- plan: TEXT (free, pro, enterprise)
- created_at: TIMESTAMP

### jobs テーブル
- id: UUID (Primary Key)
- user_id: UUID (Foreign Key → users.id)
- bbox: JSONB (north, south, east, west)
- status: TEXT (pending, running, succeeded, failed)
- created_at: TIMESTAMP
- finished_at: TIMESTAMP
- cost_estimate: DECIMAL
- error: TEXT

### assets テーブル
- id: UUID (Primary Key)
- job_id: UUID (Foreign Key → jobs.id)
- type: TEXT (model, texture, preview)
- r2_path: TEXT
- size: BIGINT
- checksum: TEXT
- created_at: TIMESTAMP

### billing_events テーブル
- id: UUID (Primary Key)
- user_id: UUID (Foreign Key → users.id)
- job_id: UUID (Foreign Key → jobs.id, nullable)
- amount: DECIMAL
- currency: TEXT
- plan: TEXT
- created_at: TIMESTAMP

## セキュリティ

- Row Level Security (RLS) を有効化
- ユーザーは自分のデータのみアクセス可能
- Cloudflare R2はプライベートバケット、署名付きURLで配布

## 実装状況

### 実装済み
- ✅ マップ表示（Mapbox Satellite）
- ✅ 範囲選択機能
- ✅ ジョブ作成API
- ✅ ジョブ状態管理
- ✅ データベーススキーマ

### 未実装
- ⏳ 3Dモデル生成処理（バックグラウンドジョブ）
- ⏳ 3Dモデル表示（Three.js）
- ⏳ 認証（Better Auth）
- ⏳ 決済（Polar）
- ⏳ ファイルアップロード（Cloudflare R2）
